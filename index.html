<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Відьмак: Генератор Подій</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23c5a059'%3E%3Cpath d='M256 0L160 192 0 224l128 128L96 512l160-96 160 96-32-160 128-128-160-32L256 0z'/%3E%3C/svg%3E">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alegreya:ital,wght@0,400;0,600;0,800;1,400&family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* Custom Global Styles */
        body {
            background-color: #020202;
            color: #a8a8a8;
            font-family: 'Alegreya', serif;
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-alegreya { font-family: 'Alegreya', serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0a0a0a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c5a059; border-radius: 2px; }
        
        /* Animations */
        @keyframes float { 
            0% { transform: translateY(0px); } 
            50% { transform: translateY(-10px); } 
            100% { transform: translateY(0px); } 
        }
        
        .perspective-1000 { perspective: 1000px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Settings = (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const MapIcon = (props) => <IconWrapper {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconWrapper>;
        const Sword = (props) => <IconWrapper {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></IconWrapper>;
        const Ship = (props) => <IconWrapper {...props}><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.9 5.8 2.38 8"/><path d="M10 2v16"/><path d="M16 6h-6"/><path d="M12 18 7 6l5-3 5 3Z"/></IconWrapper>;
        const Anchor = (props) => <IconWrapper {...props}><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></IconWrapper>;
        const Skull = (props) => <IconWrapper {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></IconWrapper>;
        const Dices = (props) => <IconWrapper {...props}><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></IconWrapper>;
        const AlertTriangle = (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>;
        const ChevronRight = (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>;
        const Feather = (props) => <IconWrapper {...props}><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="15"/></IconWrapper>;
        const XIcon = (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconWrapper>;
        const Copy = (props) => <IconWrapper {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconWrapper>;
        const Check = (props) => <IconWrapper {...props}><polyline points="20 6 9 17 4 12"/></IconWrapper>;
        const Scroll = (props) => <IconWrapper {...props}><path d="M8 17.92V22a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2H10a2 2 0 0 0-2 2Z"/><path d="M8 2v15.92a2 2 0 0 0 2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3.08a2 2 0 0 0 2-2Z"/></IconWrapper>;

        // --- ASSETS ---
        const TEXTURES = {
            paper: "https://www.transparenttextures.com/patterns/aged-paper.png",
            darkLeather: "https://www.transparenttextures.com/patterns/black-scales.png",
            fog: "https://www.transparenttextures.com/patterns/foggy-birds.png",
            runes: "https://www.transparenttextures.com/patterns/asfalt-dark.png",
            noise: "https://www.transparenttextures.com/patterns/stardust.png"
        };

        const COMMUNITY_KEY = "AIzaSyAkMxB5cWJB9OZ7yciACRFhxPp2CJ3_pew";

        // --- SYSTEM PROMPT (STRICT MECHANICS) ---
        const SYSTEM_PROMPT = `
РОЛЬ: Ти - Легендарний Архімагістр Гри (Grand Master of the Order) для настільної гри "The Witcher: Old World" (Відьмак: Старий Світ).
Ти володієш абсолютним знанням усіх правил, доповнень (Skellige, Mages, Legendary Hunt, Monster Trail, Wild Hunt, Ciri, Lost Mount) та лору всесвіту Анджея Сапковського.

ТВОЄ ЗАВДАННЯ:
Згенерувати ОДНУ картку події (Exploration Card) у форматі JSON. Це має бути шедевр наративного дизайну, який ідеально інтегрується в ігрову механіку.

--- 1. ГЛИБОКИЙ ЛОР ТА АТМОСФЕРА ---
Час дії: Золота Ера Відьмаків. Сотні років до Геральта.
Світ:
- Континент охоплений хаосом після Сопряження Сфер.
- Люди живуть у страху перед монстрами, але ще більше бояться "виродків" (відьмаків і чародіїв).
- Расизм, ксенофобія, забобони, бруд, кров і "Менше Зло" - це основа твоїх історій.
- Ніколи не пиши кліше. Замість "Ви зустріли бандитів", напиши "Група дезертирів з Нільфгаарду смажила собаку на багатті, коли ви вийшли на галявину".

Школи Відьмаків (Використовуй специфіку):
- Вовк (Каер Морхен): Професіоналізм, фехтування, нейтралітет.
- Кіт (Стигга): Емоційна нестабільність, жорстокість, наймані вбивці.
- Ведмідь (Хегг): Одинаки, важка броня, Північні острови.
- Змія (Гуліта): Отрути, подвійні кинджали, шпигунство, Ніфльгаард.
- Грифон (Каер Серен): Лицарські чесноти, магія знаків, соціальна відповідальність.
- Мантикора (Зерріканія/Схід): Алхімія, бомби, щити, пустелі.

Чародії (Mages Expansion):
- Зарозумілі, могутні, політичні інтригани. Використовують Хаос.
- Ресурс: Енергія (не Щит). Атака: Заклинання стихій.

--- 2. ДЕТАЛЬНА ІГРОВА МЕХАНІКА (СУВОРИЙ КОНТРОЛЬ) ---

А) ЖИТТЯ ТА ВИТРИВАЛІСТЬ:
   - "Рівень Щита" (Shield Level) — основний захист Відьмака.
   - "Рівень Енергії" (Energy Level) — аналог для Чародіїв (але в тексті пиши "Знизьте рівень Щита/Енергії" для універсальності).
   - Поранення (Minor): "Знизьте рівень Щита на 1-2".
   - Тяжкі рани (Major): "Скиньте 1-2 карти з верху колоди" (Deck) або "Скиньте 1-2 карти з руки" (Hand). Це сильніше покарання!

Б) ЕКОНОМІКА ТА РЕСУРСИ:
   - "Золото" (Gold/Crowns): Універсальна валюта. 1-2 золота - це обід/нічліг. 3-5 золота - це велика нагорода.
   - "Еліксир" (Potion): Ластівка, Грім, Кіт, Пурга. Ліміт 4.
   - "Бомба" (Bomb) (з Monster Trail): Самум, Картеч, Двімеритова. Ліміт 4.
   - "Жетон сліду" (Trail Token): Критично важливий для полювання на монстра. Давай його за успішне розслідування.
   - "Трофей" (Trophy): Голова монстра. Тільки за перемогу в бою (Battle). Не давай трофеї в подіях дослідження!
   - "Спорядження" (Equipment): Зрідка можна дати (меч, броня - як постійний бонус до карт).

В) НАВИЧКИ (ATTRIBUTES/SKILLS):
   - Бою (Combat): Впливає на кількість карт, які гравець бере в кінці ходу.
   - Захисту (Defense): Визначає максимальний рівень щита.
   - Алхімії (Alchemy): Визначає ліміт еліксирів/бомб.
   - Спеціалізації (Specialization): Унікальна здатність школи (наприклад, "Змія" - отрути).
   - Тренування: "Підвищіть навик [Назва] на 1". Це дуже цінна нагорода. Зазвичай вимагає оплати (Золото) або великого ризику.

Г) КОЛОДОБУДУВАННЯ (DECKBUILDING):
   - Додавання карт: "Візьміть карту вартістю 0 з ряду на полі у свій скид". (Це стандартна нагорода).
   - Треш (Trash/Видалення): "Приберіть 1 карту з гри" (Trash a card). Це дозволяє позбутися слабких стартових карт. Це ДУЖЕ сильний бонус.
   - Втома (Fatigue) - Фаза III: "У фазу III візьміть зі своєї колоди на 1 карту менше". (Гравець втомлений, не виспався, поранений).
   - Відпочинок - Фаза III: "У фазу III візьміть зі своєї колоди на 1 карту більше". (Гравець добре відпочив).

--- 3. СПЕЦИФІКА ЛОКАЦІЙ (CONTEXT) ---

ТИП "CITY" (Місто/Село/Поселення):
- Атмосфера: Галасливі ринки, темні провулки, п'яні корчми, храми, борделі, каналізація.
- Події: Покер на кістках (Dice Poker) - використовуй терміни "Каре", "Фул-хаус". Бійки з вартою/бандитами. Контракти на дошках оголошень. Зустрічі з іншими відьмаками/чародіями.
- Загрози: Кишенькові злодії (втрата золота), фанатики (бійка), отруєне пиво (втрата карт).

ТИП "WILDS" (Ліс/Гори/Болота):
- Атмосфера: Густі хащі, туманні болота, засніжені перевали, стародавні руїни ельфів, місця сили.
- Події: Сліди монстрів (отримання Жетона сліду). Зустрічі з друїдами, скоятаелями, відлюдниками. Травництво (отримання Еліксирів).
- Monster Trail: Згадуй "особливі інгредієнти" для бомб або "мутагени".

ТИП "SKELLIGE" (Острови/Море):
- Атмосфера: Солоний вітер, драккари, шторми, суворі клани, культисти Дагона.
- Події: Кораблетрощі, напади піратів клану Дімун, спів сирен, ритуали друїдів, навігація.
- Загрози: Втопитися (велика втрата карт), Дагон (втрата розуму/карт).

--- 4. СТРУКТУРА ТА БАЛАНС (ALGORITHM) ---

Правило "Еквівалентного Обміну":
- Якщо гравець отримує щось цінне (Золото > 2, Навик, Видалення карти), він повинен чимось заплатити або сильно ризикувати.
- "Безкоштовний сир тільки в мишоловці".

Приклади наслідків:
- Поганий: "Знизьте рівень Щита на 2". / "Скиньте 2 карти з руки". / "Втратьте 2 золота".
- Нейтральний: "Нічого не відбувається". / "Обміняйте 1 золото на 1 еліксир".
- Хороший: "Візьміть 2 золота". / "Візьміть 1 Еліксир". / "Візьміть 1 Жетон сліду".
- Відмінний (Рідкісний): "Підвищіть навик на 1". / "Приберіть 1 карту з гри". / "Візьміть карту вартістю 0 з ряду".

Використання Кубика (Dice Roll):
- Використовуй для перевірки удачі або навичок.
- Діапазони: "1-3 (Провал)", "4-6 (Успіх)" АБО "1-2 (Критичний провал)", "3-4 (Нейтрально)", "5-6 (Успіх)".

--- 5. ФОРМАТ ВІДПОВІДІ (JSON ONLY) ---
{
  "id": [random number 1000-9999],
  "type": "[city/wilds/skellige]",
  "title": "[Коротка, влучна назва, 2-4 слова]",
  "story": "[Атмосферний текст, 4-8 речень. Опиши сенсорні деталі: запахи, звуки. Створи конфлікт або дилему. Не пиши абстрактно.]",
  "choices": [
    {
      "label": "[Опис дії А - зазвичай агресивна або ризикована]",
      "result": "[Художній наслідок дії].\\n\\n(НАСЛІДОК): [Чіткі ігрові інструкції згідно з термінологією]"
    },
    {
      "label": "[Опис дії Б - зазвичай обережна, дипломатична або розумна]",
      "result": "[Киньте кубик]\\n1-3: [Художній опис провалу]. (НАСЛІДОК): [Штраф].\\n4-6: [Художній опис успіху]. (НАСЛІДОК): [Нагорода]."
    }
  ]
}

ГЕНЕРУЙ ТІЛЬКИ ВАЛІДНИЙ JSON. НЕ ДОДАВАЙ MARKDOWN.
`;

        // --- LOGIC UPDATE: INTELLIGENT PARSING ---
        
        const parseDiceOutcome = (text, roll) => {
            const lines = text.split('\n');
            const rangeRegex = /(?:^|\s)(\d+)(?:-(\d+))?:/;

            const matchedLines = lines.filter(line => {
                const match = line.match(rangeRegex);
                if (match) {
                const start = parseInt(match[1]);
                const end = match[2] ? parseInt(match[2]) : start;
                if (roll >= start && roll <= end) {
                    return true;
                }
                }
                return false;
            });

            if (matchedLines.length > 0) {
                return matchedLines.map(line => line.replace(rangeRegex, '').trim()).join('\n\n');
            } else {
                return text;
            }
        };

        const analyzeResult = (text) => {
            // 1. Розділення історії та наслідків
            let parts = text.split(/(?:\(НАСЛІДОК\):|НАСЛІДОК:|Наслідок:|Outcome:)/i);
            let story = parts[0].trim();
            let consequence = parts.length > 1 ? parts[1].trim() : null;

            // 2. Fallback якщо AI забув тег (шукаємо ключові слова в останньому реченні)
            if (!consequence) {
                const mechanicsKeywords = ["Знизьте", "Підніміть", "Отримайте", "Втрачаєте", "Візьміть", "Скиньте", "Додайте"];
                const sentences = story.split(/(?<=[.!?])\s+/);
                const lastSentence = sentences[sentences.length - 1];

                if (lastSentence && mechanicsKeywords.some(kw => lastSentence.includes(kw))) {
                    consequence = lastSentence;
                    story = sentences.slice(0, -1).join(' ');
                }
            }

            // 3. Розумне визначення статусу (Success/Failure)
            let status = 'neutral';
            const lowerStory = story.toLowerCase();
            const lowerCons = consequence ? consequence.toLowerCase() : "";

            // ПРІОРИТЕТ 1: Явні маркери провалу в тексті
            if (lowerStory.includes('провал') || lowerStory.includes('невдача') || lowerStory.includes('поразка') || lowerStory.includes('марно')) {
                status = 'failure';
            }
            // ПРІОРИТЕТ 2: Механічні маркери
            else if (consequence) {
                // Негативні наслідки
                if (lowerCons.includes('знизьте') || 
                    lowerCons.includes('втрачаєте') || 
                    lowerCons.includes('скиньте') || 
                    lowerCons.includes('сплатіть') ||
                    (lowerCons.includes('отримайте') && (lowerCons.includes('шкод') || lowerCons.includes('ран') || lowerCons.includes('урон')))) { 
                    // ^ Цей останній check - страховка, якщо AI все ж таки напише "Отримайте рану"
                    status = 'failure';
                } 
                // Позитивні наслідки
                else if (lowerCons.includes('отримайте') || lowerCons.includes('підніміть') || lowerCons.includes('візьміть') || lowerCons.includes('відновіть')) {
                    status = 'success';
                }
            }

            return { story, consequence, status };
        };

        const fetchLiveEvent = async (type, apiKey) => {
            if (!apiKey) throw new Error("API Key is missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const requestBody = { contents: [{ parts: [{ text: `${SYSTEM_PROMPT}\n\nТип події: "${type}". Згенеруй нову, унікальну історію.` }] }] };
            
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                if (!response.ok) throw new Error((await response.json()).error?.message || "API Error");
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                return jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(text);
            } catch (error) {
                console.error("Generation failed:", error);
                throw error;
            }
        };

        // --- UI COMPONENTS ---

        const RuneLoader = () => (
            <div className="flex flex-col items-center justify-center space-y-8 text-[#c5a059] animate-in fade-in duration-1000">
                <div className="relative w-32 h-32">
                <div className="absolute inset-0 border-[1px] border-[#c5a059]/20 rounded-full animate-[spin_10s_linear_infinite]"></div>
                <div className="absolute inset-2 border-[1px] border-[#c5a059]/40 rounded-full animate-[spin_15s_linear_infinite_reverse]"></div>
                <div className="absolute inset-0 flex items-center justify-center">
                    <div className="w-24 h-24 bg-[#c5a059]/5 rounded-full blur-xl animate-pulse"></div>
                    <Feather size={40} className="opacity-80 text-[#c5a059]" />
                </div>
                <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-2 h-2 bg-[#c5a059] rounded-full shadow-[0_0_10px_#c5a059] animate-ping"></div>
                </div>
                <span className="font-cinzel text-xs tracking-[0.5em] uppercase text-[#c5a059]/60">Створення Легенди...</span>
            </div>
        );

        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey }) => {
            const [copied, setCopied] = useState(false);
            
            const pasteKey = () => {
                setApiKey(COMMUNITY_KEY);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-xl animate-in fade-in duration-300">
                <div className="relative bg-[#050505] border border-[#c5a059]/30 p-10 w-full max-w-lg shadow-[0_0_100px_rgba(197,160,89,0.1)] rounded-sm overflow-hidden">
                    <div className="absolute inset-0 opacity-5 pointer-events-none" style={{backgroundImage: `url(${TEXTURES.runes})`}}></div>
                    
                    <button onClick={onClose} className="absolute top-6 right-6 text-[#444] hover:text-[#c5a059] transition-colors">
                    <XIcon size={24}/>
                    </button>

                    <div className="mb-10 text-center relative z-10">
                    <Settings size={40} className="text-[#c5a059] mx-auto mb-4 opacity-80" />
                    <h2 className="font-cinzel text-[#e8dcca] text-3xl tracking-[0.2em] font-bold">Налаштування</h2>
                    </div>

                    <div className="space-y-8 relative z-10">
                    <div>
                        <label className="block text-xs font-cinzel font-bold text-[#666] mb-3 tracking-[0.2em] uppercase">Gemini API Key</label>
                        <div className="relative group">
                        <input 
                            type="password" 
                            value={apiKey} 
                            onChange={(e) => setApiKey(e.target.value)} 
                            placeholder="Вставте ключ тут..." 
                            className="w-full bg-[#0a0a0a] border border-[#333] p-4 text-[#c5a059] text-sm focus:border-[#c5a059] outline-none rounded-sm font-mono placeholder:text-[#333] transition-all shadow-inner"
                        />
                        </div>
                        
                        <div className="mt-4 flex justify-center">
                            <button 
                            onClick={pasteKey}
                            className="flex items-center gap-2 text-xs font-cinzel text-[#c5a059] hover:text-[#ffeec2] transition-colors border border-[#c5a059]/30 px-4 py-2 rounded-sm hover:bg-[#c5a059]/10"
                            >
                            {copied ? <Check size={14} /> : <Copy size={14} />}
                            {copied ? "Ключ Вставлено" : "Вставити Ключ Спільноти"}
                            </button>
                        </div>
                    </div>
                    </div>

                    <button 
                    onClick={onClose} 
                    className="w-full mt-10 py-5 bg-[#c5a059] hover:bg-[#d4b575] text-black font-cinzel text-sm uppercase font-bold tracking-[0.3em] transition-all duration-300 shadow-[0_0_30px_rgba(197,160,89,0.2)]"
                    >
                    Підтвердити
                    </button>
                </div>
                </div>
            );
        };

        const DiceInput = ({ onInput }) => (
            <div className="w-full max-w-md mx-auto animate-in fade-in slide-in-from-bottom-8 duration-700">
                <div className="text-center mb-8">
                <p className="text-[#c5a059] font-cinzel text-lg tracking-[0.2em] uppercase font-bold mb-3 drop-shadow-lg">Випробування Долі</p>
                <div className="h-[1px] w-24 bg-[#c5a059]/50 mx-auto mb-4"></div>
                <p className="text-[#666] font-serif italic text-base">Киньте фізичний кубик та оберіть результат</p>
                </div>
                <div className="grid grid-cols-3 gap-6">
                    {[1, 2, 3, 4, 5, 6].map(num => (
                    <button 
                        key={num} 
                        onClick={() => onInput(num)}
                        className="
                        group relative aspect-square flex items-center justify-center 
                        bg-[#0a0a0a] border border-[#333] hover:border-[#c5a059] 
                        transition-all duration-300 transform hover:-translate-y-2 hover:shadow-[0_10px_30px_rgba(197,160,89,0.1)]
                        "
                    >
                        <span className="font-cinzel font-black text-4xl text-[#333] group-hover:text-[#c5a059] transition-colors duration-500">{num}</span>
                    </button>
                    ))}
                </div>
            </div>
        );

        const ActionButton = ({ onClick, label, index }) => (
            <button 
                onClick={onClick}
                className="
                group w-full text-left relative overflow-hidden mb-6 transition-all duration-500 
                bg-gradient-to-r from-[#080808] to-[#050505] border border-[#222] hover:border-[#c5a059]
                shadow-lg hover:shadow-[0_0_20px_rgba(197,160,89,0.1)]
                "
            >
                <div className="flex items-stretch">
                <div className="w-20 flex flex-col items-center justify-center border-r border-[#222] group-hover:border-[#c5a059]/30 bg-[#030303] transition-colors duration-500">
                    <span className="font-cinzel text-[#333] group-hover:text-[#c5a059] font-black text-3xl transition-colors duration-500">
                    {index === 0 ? 'I' : 'II'}
                    </span>
                </div>
                <div className="flex-1 p-6 flex items-center relative">
                    <span className="font-alegreya text-[#b0b0b0] text-xl leading-relaxed group-hover:text-[#e8dcca] transition-colors duration-300">
                    {label}
                    </span>
                </div>
                </div>
            </button>
        );

        const ResultView = ({ resultData, roll, onReset }) => {
            const { story, consequence, status } = resultData;

            const styles = {
                success: {
                    color: 'text-emerald-500',
                    border: 'border-emerald-500/50',
                    bg: 'bg-emerald-900/20',
                    title: 'УСПІХ',
                    icon: Check
                },
                failure: {
                    color: 'text-red-500',
                    border: 'border-red-500/50',
                    bg: 'bg-red-900/20',
                    title: 'ПРОВАЛ',
                    icon: Skull
                },
                neutral: {
                    color: 'text-[#c5a059]',
                    border: 'border-[#c5a059]/50',
                    bg: 'bg-[#c5a059]/10',
                    title: 'ДОЛЯ ВИРІШЕНА',
                    icon: Scroll
                }
            };

            const theme = styles[status] || styles.neutral;
            const StatusIcon = theme.icon;

            return (
                <div className="flex flex-col h-full animate-in fade-in slide-in-from-bottom-8 duration-700 p-6 md:p-8">
                    <div className="flex-1 flex flex-col justify-center items-center">
                        <div className={`w-full relative bg-[#080808]/95 border ${theme.border} shadow-2xl rounded-sm p-8 md:p-10 overflow-hidden`}>
                            <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-full h-32 ${theme.bg} blur-3xl opacity-40 pointer-events-none`}></div>

                            <div className="flex flex-col items-center justify-center gap-4 mb-8 relative z-10">
                                {roll && (
                                    <div className={`
                                        w-16 h-16 flex items-center justify-center border-2 ${theme.border} 
                                        ${theme.color} font-cinzel font-bold text-3xl bg-black 
                                        shadow-[0_0_20px_rgba(0,0,0,0.5)] rotate-3 transform hover:rotate-6 transition-transform
                                    `}>
                                        {roll}
                                    </div>
                                )}
                                
                                <div className="flex items-center gap-3">
                                    <StatusIcon className={theme.color} size={28} />
                                    <h3 className={`font-cinzel ${theme.color} text-2xl uppercase tracking-[0.3em] font-bold drop-shadow-md`}>
                                        {theme.title}
                                    </h3>
                                    <StatusIcon className={theme.color} size={28} style={{transform: 'scaleX(-1)'}} />
                                </div>
                            </div>

                            <div className="relative mb-8">
                                <p className="font-alegreya text-xl md:text-2xl text-[#e8dcca] italic leading-loose text-center">
                                    {story}
                                </p>
                            </div>

                            {/* Render consequence if detected OR if narrative implies a result */}
                            {consequence ? (
                                <div className="relative mt-6 animate-in slide-in-from-bottom-4 delay-300 w-full">
                                    <div className="absolute inset-0 border border-white/10 bg-white/5 transform skew-x-[-2deg]"></div>
                                    <div className={`
                                        relative p-6 border-l-4 ${theme.border} bg-[#050505]
                                        flex flex-col items-center text-center gap-2
                                    `}>
                                        <span className="font-cinzel text-[10px] uppercase tracking-[0.4em] text-[#888]">Наслідок</span>
                                        <p className="font-cinzel font-bold text-lg md:text-xl text-white tracking-wide">
                                            {consequence}
                                        </p>
                                    </div>
                                </div>
                            ) : status === 'failure' ? (
                                /* Fallback for visible failure without specific extracted text */
                                <div className="relative mt-6 animate-in slide-in-from-bottom-4 delay-300 w-full">
                                    <div className={`relative p-4 border border-red-900/30 bg-red-950/10 text-center`}>
                                        <span className="font-cinzel text-xs text-red-400 uppercase tracking-widest">Вас Спіткала Невдача</span>
                                    </div>
                                </div>
                            ) : null}
                        </div>
                    </div>

                    <div className="pt-6 mt-4 w-full max-w-xl mx-auto">
                        <button 
                            onClick={onReset}
                            className="
                            group w-full py-5 bg-[#8a1c1c] hover:bg-[#a02222] text-[#e8dcca] 
                            font-cinzel font-bold text-lg uppercase tracking-[0.25em] 
                            transition-all rounded-sm flex items-center justify-center gap-4 
                            shadow-[0_5px_15px_rgba(0,0,0,0.5)] border border-white/10 
                            transform hover:-translate-y-1
                            "
                        >
                            <span>Далі в Дорогу</span>
                            <ChevronRight size={20} className="group-hover:translate-x-1 transition-transform" />
                        </button>
                    </div>
                </div>
            );
        };

        const ModeButton = ({ active, onClick, icon: Icon, label, themeColor }) => (
            <button 
                onClick={onClick}
                className={`
                relative flex-1 py-6 flex flex-col items-center justify-center gap-3 
                transition-all duration-700 group overflow-hidden
                ${active ? 'opacity-100' : 'opacity-40 hover:opacity-70'}
                `}
            >
                {active && (
                    <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-gradient-to-b from-${themeColor}-500/10 to-transparent blur-md`}></div>
                )}
                <Icon size={24} className={`relative z-10 transition-all duration-500 ${active ? `text-${themeColor}-400 drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]` : 'text-[#888]'}`} />
                <span className={`relative z-10 font-cinzel text-xs font-bold uppercase tracking-[0.2em] transition-colors ${active ? 'text-[#e8dcca]' : 'text-[#666]'}`}>
                {label}
                </span>
                {active && (
                    <div className={`absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-[2px] bg-${themeColor}-500 shadow-[0_0_10px_currentColor]`}></div>
                )}
            </button>
        );

        function WitcherAppDeep() {
            const [activeTab, setActiveTab] = useState('city');
            const [viewState, setViewState] = useState('start');
            const [apiKey, setApiKey] = useState('');
            const [currentCard, setCurrentCard] = useState(null);
            const [diceCallback, setDiceCallback] = useState(null);
            const [resultText, setResultText] = useState(null);
            const [userRoll, setUserRoll] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            
            const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

            useEffect(() => {
                const savedKey = localStorage.getItem('witcher_api_key');
                if (savedKey) setApiKey(savedKey);

                const handleMove = (e) => {
                    setMousePos({
                        x: (e.clientX / window.innerWidth - 0.5) * 15,
                        y: (e.clientY / window.innerHeight - 0.5) * 15
                    });
                };
                window.addEventListener('mousemove', handleMove);
                return () => window.removeEventListener('mousemove', handleMove);
            }, []);

            useEffect(() => { if (apiKey) localStorage.setItem('witcher_api_key', apiKey); }, [apiKey]);

            const generateEvent = async () => {
                setLoading(true);
                setError(null);
                setViewState('story');
                setUserRoll(null);
                try {
                    if (!apiKey) {
                    setShowSettings(true);
                    throw new Error("Ключ Сфер відсутній.");
                    }
                    const liveData = await fetchLiveEvent(activeTab, apiKey);
                    setCurrentCard(liveData);
                } catch (err) { 
                    setError(err.message); 
                    setViewState('start'); 
                } finally { 
                    setLoading(false); 
                }
            };

            const handleChoice = (choice) => {
                if (choice.result.toLowerCase().includes("киньте кубик") || choice.result.match(/\d-\d:/)) {
                    setViewState('dice');
                    setDiceCallback(() => (roll) => {
                        setUserRoll(roll);
                        const outcome = parseDiceOutcome(choice.result, roll);
                        const analysis = analyzeResult(outcome);
                        setResultText(analysis);
                        setViewState('result');
                    });
                } else {
                    setUserRoll(null);
                    const analysis = analyzeResult(choice.result);
                    setResultText(analysis);
                    setViewState('result');
                }
            };

            const reset = () => { setViewState('start'); setCurrentCard(null); };

            const themeColor = activeTab === 'city' ? 'amber' : activeTab === 'skellige' ? 'cyan' : 'emerald';

            return (
                <div className="min-h-screen bg-[#020202] text-[#a8a8a8] font-sans pb-0 selection:bg-[#c5a059] selection:text-black overflow-hidden">
                
                <div className="fixed inset-0 z-0 pointer-events-none">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,#000_100%)] z-20"></div>
                    <div className="absolute inset-[-10%] opacity-10 mix-blend-screen transition-transform duration-1000 ease-out z-10" style={{backgroundImage: `url(${TEXTURES.fog})`, transform: `translate(${mousePos.x * -2}px, ${mousePos.y * -2}px) scale(1.2)`}}></div>
                    <div className={`absolute inset-0 transition-colors duration-1000 z-0 ${activeTab === 'city' ? 'bg-[#1a1208]' : activeTab === 'skellige' ? 'bg-[#08141a]' : 'bg-[#0a1a0f]'}`}></div>
                    <div className="absolute inset-0 opacity-5 mix-blend-overlay" style={{backgroundImage: `url(${TEXTURES.noise})`}}></div>
                </div>
                
                <div className="relative z-10 w-full max-w-4xl mx-auto min-h-screen flex flex-col border-x border-white/5 bg-black/40 shadow-2xl backdrop-blur-sm">
                    <header className="p-0 relative z-30">
                    <div className="absolute inset-x-0 bottom-0 h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                    <div className="p-8 pb-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-4xl font-cinzel font-black text-[#c5a059] tracking-[0.15em] uppercase drop-shadow-[0_0_15px_rgba(197,160,89,0.3)]">Відьмак</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <div className="h-[1px] w-8 bg-[#c5a059]/50"></div>
                                <span className="text-[10px] text-[#888] font-cinzel tracking-[0.4em] uppercase">Генератор Подій</span>
                            </div>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="text-[#444] hover:text-[#c5a059] transition-all duration-500 transform hover:rotate-180">
                            <Settings size={24}/>
                        </button>
                    </div>
                    <div className="flex w-full px-8">
                        <ModeButton active={activeTab === 'city'} onClick={() => {setActiveTab('city'); reset();}} icon={MapIcon} label="Місто" themeColor="amber"/>
                        <ModeButton active={activeTab === 'wilds'} onClick={() => {setActiveTab('wilds'); reset();}} icon={Sword} label="Нетрі" themeColor="emerald"/>
                        <ModeButton active={activeTab === 'skellige'} onClick={() => {setActiveTab('skellige'); reset();}} icon={Ship} label="Скелліге" themeColor="cyan"/>
                    </div>
                    </header>

                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} apiKey={apiKey} setApiKey={setApiKey} />

                    <main className="flex-1 p-6 flex flex-col justify-center relative">
                    {error && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-red-950/80 border border-red-900/50 p-4 rounded-sm text-red-200 text-sm flex gap-4 items-center backdrop-blur-md animate-in slide-in-from-top-2 shadow-xl z-50">
                            <AlertTriangle size={18}/>
                            <p className="font-cinzel tracking-wide">{error}</p>
                        </div>
                    )}
                    
                    {viewState === 'start' && !loading && (
                        <div className="flex flex-col items-center justify-center text-center h-[500px] animate-in fade-in duration-1000">
                        <div className="relative mb-12 group cursor-pointer" onClick={generateEvent}>
                            <div className={`absolute inset-0 rounded-full blur-[60px] opacity-20 group-hover:opacity-50 transition-opacity duration-1000 ${activeTab === 'city' ? 'bg-amber-500' : activeTab === 'skellige' ? 'bg-cyan-500' : 'bg-emerald-500'}`}></div>
                            <div className={`relative w-48 h-48 flex items-center justify-center transition-transform duration-700 group-hover:scale-105`}>
                                {activeTab === 'city' ? <MapIcon size={100} strokeWidth={0.5} className="text-[#c5a059] drop-shadow-[0_0_10px_rgba(0,0,0,0.8)]" /> : 
                                activeTab === 'skellige' ? <Anchor size={100} strokeWidth={0.5} className="text-cyan-600 drop-shadow-[0_0_10px_rgba(0,0,0,0.8)]" /> : 
                                <Sword size={100} strokeWidth={0.5} className="text-emerald-600 drop-shadow-[0_0_10px_rgba(0,0,0,0.8)]" />}
                            </div>
                        </div>
                        <h2 className="text-3xl font-cinzel text-[#e8dcca] mb-8 tracking-[0.2em] font-bold opacity-90">
                            {activeTab === 'city' ? 'Дослідити Місто' : activeTab === 'skellige' ? 'Вийти в Море' : 'Вирушити в Шлях'}
                        </h2>
                        <button onClick={generateEvent} className="px-16 py-5 bg-transparent border border-[#c5a059]/50 text-[#c5a059] font-cinzel font-bold text-sm uppercase tracking-[0.3em] hover:bg-[#c5a059] hover:text-black transition-all duration-500">
                            Почати
                        </button>
                        </div>
                    )}

                    {loading && (
                        <div className="h-[600px] flex flex-col items-center justify-center animate-in fade-in duration-700">
                        <RuneLoader />
                        </div>
                    )}

                    {!loading && currentCard && viewState !== 'start' && (
                        <div className="w-full max-w-3xl mx-auto h-full min-h-[600px] flex flex-col animate-in zoom-in-95 duration-700">
                        <div className={`relative w-full flex-1 bg-[#0f0f0f] shadow-[0_20px_60px_rgba(0,0,0,0.7)] border border-white/10 flex flex-col overflow-hidden rounded-sm group`}>
                            <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-${themeColor}-600 to-transparent opacity-50`}></div>
                            {viewState === 'story' && (
                                <div className="p-8 pb-4 text-center relative z-10">
                                    <div className="inline-flex items-center gap-3 mb-2 opacity-50">
                                        <div className="h-[1px] w-8 bg-[#c5a059]"></div>
                                        <span className="font-cinzel text-[10px] uppercase tracking-[0.3em] text-[#c5a059]">Подія #{currentCard.id}</span>
                                        <div className="h-[1px] w-8 bg-[#c5a059]"></div>
                                    </div>
                                    <h2 className="text-3xl md:text-4xl font-cinzel font-bold text-[#e8dcca] leading-tight drop-shadow-lg">{currentCard.title}</h2>
                                </div>
                            )}
                            <div className="flex-1 relative p-8 md:p-12 pt-4 overflow-hidden flex flex-col">
                                <div className="absolute inset-0 opacity-30 pointer-events-none mix-blend-overlay" style={{backgroundImage: `url(${TEXTURES.darkLeather})`}}></div>
                                <div className="absolute inset-0 opacity-10 pointer-events-none mix-blend-multiply" style={{backgroundImage: `url(${TEXTURES.paper})`}}></div>
                                
                                {viewState === 'story' && (
                                    <div className="flex-1 flex flex-col h-full animate-in fade-in slide-in-from-bottom-4 duration-700 relative z-10">
                                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-6">
                                            <p className="font-alegreya text-2xl md:text-3xl text-[#dcd1bc] leading-loose text-justify whitespace-pre-wrap drop-shadow-sm first-letter:text-5xl first-letter:float-left first-letter:mr-3 first-letter:text-[#c5a059]">
                                                {currentCard.story}
                                            </p>
                                        </div>
                                        <div className="mt-8 space-y-4 pt-8 border-t border-white/5">
                                            {currentCard.choices.map((c, i) => (<ActionButton key={i} index={i} label={c.label} onClick={() => handleChoice(c)} />))}
                                        </div>
                                    </div>
                                )}
                                {viewState === 'dice' && (
                                    <div className="flex-1 flex flex-col items-center justify-center relative z-10 animate-in zoom-in-95">
                                        <div className="absolute inset-0 bg-[#c5a059] blur-[100px] opacity-5"></div>
                                        <Dices size={80} className="text-[#c5a059] mb-8 drop-shadow-[0_0_25px_rgba(197,160,89,0.6)]"/>
                                        <DiceInput onInput={diceCallback} />
                                    </div>
                                )}
                                {viewState === 'result' && resultText && (<ResultView resultData={resultText} roll={userRoll} onReset={reset} />)}
                            </div>
                        </div>
                        </div>
                    )}
                    </main>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WitcherAppDeep />);
    </script>
</body>
</html>
